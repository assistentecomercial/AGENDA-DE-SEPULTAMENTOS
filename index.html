<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda de Sepultamentos</title>
<style>
  body { font-family: Arial, sans-serif; background: #fefefe; padding: 20px; }
  h1 { text-align: center; }
  .container { display: flex; justify-content: space-around; margin-top: 20px; gap: 20px; }
  .coluna { flex: 1; }
  .coluna h2 { text-align: center; background: #eee; padding: 10px; border-radius: 6px; }
  .card { border: 1px solid #ccc; padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .livre { background-color: #d4edda; }
  .ocupado { background-color: #f8d7da; }
  button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .info { display: flex; flex-direction: column; margin-top: 5px; font-size: 0.9em; color: #333; }
</style>
</head>
<body>

<h1>Agenda de Sepultamentos</h1>
<div class="container">
  <div class="coluna">
    <h2>ðŸŒ… ManhÃ£</h2>
    <div id="manha"></div>
  </div>
  <div class="coluna">
    <h2>ðŸŒ‡ Tarde</h2>
    <div id="tarde"></div>
  </div>
</div>

<script>
const API_KEY = "patOFccvkTYdyuFT5"; 
const BASE_ID = "app2lNLG6HAy5tHmx"; 
const TABLE_NAME = "Agenda de Sepultamentos";

// Puxa os registros
async function fetchAgenda() {
  const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?view=Grid%20view`, {
    headers: { "Authorization": `Bearer ${API_KEY}` }
  });
  const data = await res.json();
  displayAgenda(data.records);
}

// Mostra os horÃ¡rios nas colunas
function displayAgenda(records) {
  const manhaContainer = document.getElementById("manha");
  const tardeContainer = document.getElementById("tarde");
  manhaContainer.innerHTML = "";
  tardeContainer.innerHTML = "";

  records.forEach(record => {
    const { HorÃ¡rio, Status, Periodo, Falecido, Atendente, Setor } = record.fields;

    const card = document.createElement("div");
    card.className = "card " + (Status === "Livre" ? "livre" : "ocupado");

    let conteudo = `<span>${HorÃ¡rio} - ${Status}</span>`;

    if(Status === "Ocupado") {
      conteudo += `<div class="info">
                    <div><strong>Falecido:</strong> ${Falecido}</div>
                    <div><strong>Atendente:</strong> ${Atendente}</div>
                    <div><strong>Setor:</strong> ${Setor}</div>
                  </div>`;
    }

    const botaoReservar = Status === "Livre" 
      ? `<button onclick="reservar('${record.id}')">Reservar</button>` 
      : `<button disabled>Reservado</button>`;

    card.innerHTML = conteudo + botaoReservar;

    let periodo = Periodo;
    if (!periodo) {
      const horaNum = parseInt(HorÃ¡rio.split("h")[0], 10);
      periodo = horaNum < 12 ? "ManhÃ£" : "Tarde";
    }

    if (periodo === "ManhÃ£") manhaContainer.appendChild(card);
    else tardeContainer.appendChild(card);
  });
}

// Reserva um horÃ¡rio
async function reservar(recordId) {
  const falecido = prompt("Nome do Falecido:");
  if(!falecido) return alert("Ã‰ obrigatÃ³rio preencher o nome do falecido.");

  const atendente = prompt("Nome do Atendente:");
  if(!atendente) return alert("Ã‰ obrigatÃ³rio preencher o nome do atendente.");

  const pendencia = prompt("Possui pendÃªncia para o sepultamento? (Sim/NÃ£o):");
  if(!pendencia) return alert("Ã‰ obrigatÃ³rio informar se hÃ¡ pendÃªncia.");

  const setor = prompt("Setor do Sepultamento:");
  if(!setor) return alert("Ã‰ obrigatÃ³rio preencher o setor do sepultamento.");

  const body = {
    fields: { 
      Falecido: falecido, 
      Atendente: atendente, 
      Pendencia: pendencia,
      Setor: setor,
      Status: "Ocupado"
    }
  };

  await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}`, {
    method: "PATCH",
    headers: {
      "Authorization": `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  alert("HorÃ¡rio reservado com sucesso!");
  fetchAgenda();
}

// Carrega agenda ao abrir
fetchAgenda();
</script>

</body>
</html>
