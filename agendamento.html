<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Calendário de Sepultamentos</title>
<style>
body {
  font-family: Garamond, serif;
  background:#f0f2f5;
  margin:0;
  padding:20px;
}
.topo {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.topo h2 { color:#28a745; }
.topo button {
  background:#28a745;
  color:white;
  border:none;
  padding:10px 15px;
  border-radius:8px;
  cursor:pointer;
  transition:0.2s;
}
.topo button:hover { background:#218838; }

/* CONTAINER PRINCIPAL */
.container {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

/* QUADRO DE SEPULTAMENTOS */
.cardDia {
  background:#f8f9fa;
  border:1px solid #ccc;
  border-radius:12px;
  padding:10px;
  flex:1 1 180px;
}
.cardDia h4 { text-align:center; color:#28a745; margin-top:0; }
.cardAgendamento {
  background:#e9ecef;
  padding:6px;
  margin:4px 0;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:0.2s;
}
.cardAgendamento:hover { transform:scale(1.02); }
.cardAgendamento.alerta { background:#dc3545; color:white; font-weight:bold; }

/* HORÁRIOS */
#horarios { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
#horarios div { display:flex; flex-direction:column; gap:5px; }
.hora {
  padding:6px 10px;
  border:1px solid #000;
  border-radius:5px;
  cursor:pointer;
  transition:0.2s;
}
.hora.ocupado { background:red; color:white; cursor:not-allowed; }
.hora.selecionado { background:green; color:white; }
.hora:hover:not(.ocupado):not(.selecionado) { background:#d4edda; }

/* RESUMO */
#resumo { margin-top:20px; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc; }

/* RESPONSIVO */
@media(max-width:900px){ .container{flex-direction:column;} }
</style>
</head>
<body>

<div class="topo">
  <h2>Calendário de Sepultamentos</h2>
  <button onclick="window.location.href='login.html'">Voltar ao Login</button>
</div>

<label>Selecione a data: <input type="date" id="data"></label>

<div id="horarios"></div>
<div id="resumo"></div>

<div class="container" id="diasCalendario"></div>

<!-- Importa Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
// ===== CONFIGURAÇÃO =====
const SUPABASE_URL = "https://upgvfyinupjboovvobdm.supabase.co";
const SUPABASE_KEY = "sb_publishable_YKLtx78hj_0DcAcZIsI9kg_CDdXQD01";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const usuarioLogado = localStorage.getItem("usuarioLogado") || "";
const isAdmin = localStorage.getItem("isAdmin") === "true";
document.getElementById("nomeUsuario")?.textContent = usuarioLogado;

let horarioSelecionado = null;
const dataInput = document.getElementById("data");
const resumoEl = document.getElementById("resumo");
let agendamentos = [];
let horariosDoDia = [];

// ===== CONFIGURAÇÃO DE DATAS =====
const hoje = new Date();
const hojeStr = hoje.toISOString().split("T")[0];
const maxData = new Date();
maxData.setDate(hoje.getDate() + 5);
dataInput.min = hojeStr;
dataInput.max = maxData.toISOString().split("T")[0];

dataInput.addEventListener("input", () => {
  if (dataInput.value < hojeStr) dataInput.value = hojeStr;
  if (dataInput.value > dataInput.max) dataInput.value = maxData.toISOString().split("T")[0];
  carregarHorariosDoDia(dataInput.value);
  mostrarSepultamentosDia();
});

// ===== CARREGAR AGENDAMENTOS =====
async function carregarAgendamentos() {
  const { data, error } = await supabase.from("agendamentos").select("*");
  if(error) return console.error(error);
  agendamentos = data;
  carregarHorariosDoDia(dataInput.value || hojeStr);
  mostrarSepultamentosDia();
}
carregarAgendamentos();

// ===== CARREGAR HORÁRIOS DO DIA =====
async function carregarHorariosDoDia(data) {
  if(!data) return;
  const { data: horarios, error } = await supabase
    .from("horarios")
    .select("*")
    .eq("data", data)
    .order("hora", { ascending: true });
  if(error) return console.error(error);

  horariosDoDia = horarios;
  gerarHorarios();
}

// ===== GERAR HORÁRIOS =====
function gerarHorarios() {
  const data = dataInput.value;
  if(!data) return;

  const container = document.getElementById("horarios");
  container.innerHTML = "";
  horarioSelecionado = null;

  const ocupados = agendamentos.filter(a => a.Data === data);

  const manha = document.createElement("div");
  const tarde = document.createElement("div");

  horariosDoDia.forEach(h => {
    const div = document.createElement("div");
    div.classList.add("hora");
    div.textContent = h.hora;

    const regOcupado = ocupados.find(a => a.Hora === h.hora);
    if(regOcupado){
      div.classList.add("ocupado");
      if(isAdmin){
        div.onclick = async ()=>{
          if(confirm(`Excluir horário ${h.hora}?`)){
            await supabase.from("agendamentos").delete().eq("id", regOcupado.id);
            carregarAgendamentos();
          }
        };
      }
    } else {
      const dtHorario = new Date(`${data}T${h.hora}:00-03:00`);
      if(data === hojeStr && dtHorario < new Date()) {
        div.classList.add("ocupado");
      } else {
        div.onclick = () => selecionarHorario(div, h.hora);
      }
    }

    if(h.periodo === "manha") manha.appendChild(div);
    else tarde.appendChild(div);
  });

  container.appendChild(manha);
  container.appendChild(tarde);
}

// ===== SELECIONAR HORÁRIO =====
function selecionarHorario(div,hora){
  document.querySelectorAll(".hora").forEach(h=>h.classList.remove("selecionado"));
  div.classList.add("selecionado");
  horarioSelecionado = hora;
  atualizarResumo();
}

// ===== ATUALIZAR RESUMO =====
function atualizarResumo(){
  resumoEl.innerHTML = `
    <h3>Resumo do Agendamento</h3>
    <p><b>Data:</b> ${dataInput.value||"-"}</p>
    <p><b>Hora:</b> ${horarioSelecionado||"-"}</p>
    <p><b>Atendente:</b> ${usuarioLogado||"-"}</p>
  `;
}

// ===== CONFIRMAR AGENDAMENTO =====
async function confirmarAgendamento(){
  if(!dataInput.value || !horarioSelecionado){
    return alert("Selecione data e horário!");
  }

  if(agendamentos.some(a=>a.Hora===horarioSelecionado && a.Data===dataInput.value)){
    return alert("Este horário já está ocupado!");
  }

  const { error } = await supabase.from("agendamentos").insert([{
    Data: dataInput.value,
    Hora: horarioSelecionado,
    Atendente: usuarioLogado
  }]);

  if(error) return alert("Erro ao agendar: "+error.message);
  carregarAgendamentos();
  atualizarResumo();
}

// ===== MOSTRAR SEPULTAMENTOS =====
function mostrarSepultamentosDia(){
  const container = document.getElementById("diasCalendario");
  container.innerHTML="";

  for(let i=0;i<5;i++){
    const dia = new Date();
    dia.setDate(hoje.getDate()+i);
    const diaStr = dia.toISOString().split("T")[0];
    const cardDia = document.createElement("div");
    cardDia.classList.add("cardDia");

    const titulo = document.createElement("h4");
    titulo.textContent = "SEPULTAMENTO - "+ dia.toLocaleDateString("pt-BR",{weekday:"short",day:"2-digit",month:"2-digit"});
    cardDia.appendChild(titulo);

    const registros = agendamentos.filter(a=>a.Data===diaStr);
    if(registros.length===0){
      const vazio = document.createElement("p"); vazio.textContent="Nenhum agendamento";
      cardDia.appendChild(vazio);
    }

    registros.forEach(a=>{
      const div = document.createElement("div");
      div.classList.add("cardAgendamento");
      div.textContent=`${a.Hora} - ${a.Falecido || "-"}`;
      cardDia.appendChild(div);
    });

    container.appendChild(cardDia);
  }
}
</script>
</body>
</html>
